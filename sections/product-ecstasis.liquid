{% schema %}
{
  "name": "Producto Valentón",
  "settings": [
    {
      "type": "product",
      "id": "product_pack_1",
      "label": "Producto Pack 1 Botella"
    },
    {
      "type": "product",
      "id": "product_pack_3",
      "label": "Producto Pack 3 Botellas (Recomendado)"
    },
    {
      "type": "product",
      "id": "product_pack_6",
      "label": "Producto Pack 6 Botellas"
    },
    {
      "type": "text",
      "id": "product_type_label",
      "label": "Etiqueta Tipo Producto",
      "default": "Tinto dulce gamberro"
    },
    {
      "type": "text",
      "id": "product_title",
      "label": "Título Producto",
      "default": "Pack Valentón"
    },
    {
      "type": "textarea",
      "id": "product_description",
      "label": "Descripción Producto",
      "default": "Olvídate del maridaje complejo. Valentón es para maridar con tus malas decisiones del sábado noche. Tinto, dulce y peligroso. Elige tu tamaño según el nivel de desastre que preveas."
    },
    {
      "type": "text",
      "id": "shipping_info",
      "label": "Info Envío",
      "default": "Envío gratis 24/48h"
    },
    {
      "type": "image_picker",
      "id": "pack_image_1",
      "label": "Imagen Pack 1 Botella"
    },
    {
      "type": "image_picker",
      "id": "pack_image_3",
      "label": "Imagen Pack 3 Botellas"
    },
    {
      "type": "image_picker",
      "id": "pack_image_6",
      "label": "Imagen Pack 6 Botellas"
    }
  ]
}
{% endschema %}

{%- assign product_1 = all_products[section.settings.product_pack_1] -%}
{%- assign product_3 = all_products[section.settings.product_pack_3] -%}
{%- assign product_6 = all_products[section.settings.product_pack_6] -%}

<!-- SECTION 2: PRODUCT CONFIGURATOR -->
<section class="lg:px-0 border-stone-200 border-b relative bg-white" id="valenton">
  <div class="grid grid-cols-1 lg:grid-cols-2">
    
    <!-- Interactive Product Showcase (Sticky on Desktop) -->
    <div class="relative h-[600px] lg:h-auto lg:min-h-screen bg-[#F0EEE6] flex items-center justify-center overflow-hidden lg:sticky lg:top-0 border-b lg:border-b-0 lg:border-r border-stone-200 group">
      <div class="absolute inset-0 w-full h-full">
        <!-- Wrapper for full-bleed images -->
        <div class="w-full h-full relative">
          <!-- Pack 1 Image -->
          {% if section.settings.pack_image_1 != blank %}
            <img src="{{ section.settings.pack_image_1 | img_url: '1600x' }}" alt="Pack Solitario" class="absolute inset-0 w-full h-full object-cover transition-all duration-1000 ease-in-out z-20" id="pack-img-1">
          {% else %}
            <div class="absolute inset-0 w-full h-full bg-stone-100 z-20" id="pack-img-1"></div>
          {% endif %}
          
          <!-- Pack 3 Image -->
          {% if section.settings.pack_image_3 != blank %}
            <img src="{{ section.settings.pack_image_3 | img_url: '1600x' }}" id="pack-img-3" alt="Pack Trío" class="absolute inset-0 w-full h-full object-cover transition-all duration-1000 ease-in-out opacity-0 z-20">
          {% else %}
            <div class="absolute inset-0 w-full h-full bg-stone-200 opacity-0 z-20" id="pack-img-3"></div>
          {% endif %}
          
          <!-- Pack 6 Image -->
          {% if section.settings.pack_image_6 != blank %}
            <img src="{{ section.settings.pack_image_6 | img_url: '1600x' }}" id="pack-img-6" alt="Pack Multitud" class="absolute inset-0 w-full h-full object-cover transition-all duration-1000 ease-in-out opacity-0 z-20">
          {% else %}
            <div class="absolute inset-0 w-full h-full bg-stone-300 opacity-0 z-20" id="pack-img-6"></div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Product Details & Configuration -->
    <div class="flex flex-col justify-center px-6 py-24 lg:px-20 lg:py-24 bg-white relative z-30">
      <div class="max-w-lg w-full mx-auto space-y-12">
        
        <div class="space-y-2">
          <div class="flex items-center gap-2 mb-4">
            <span class="bg-red-50 text-red-600 px-2 py-1 rounded-md text-[10px] font-bold uppercase tracking-widest border border-red-100">Edición Limitada</span>
            <div class="h-px bg-stone-100 flex-1"></div>
          </div>
          <h2 class="text-4xl md:text-5xl font-bold tracking-tight text-stone-900">{{ section.settings.product_title }}</h2>
          <p class="text-lg text-stone-500 font-medium">{{ section.settings.product_type_label }}</p>
        </div>

        <!-- Configurator -->
        <div class="space-y-6">
          <div class="flex justify-between items-end">
            <span class="text-xs font-bold uppercase tracking-widest text-stone-900">Selecciona tu dosis</span>
            <span class="text-[10px] text-stone-400">{{ section.settings.shipping_info }}</span>
          </div>

          <div class="grid gap-3">
            <!-- Option 1 -->
            <label class="relative cursor-pointer group">
              <input type="radio" name="pack" value="1" class="peer sr-only" onchange="updateProduct(1)" {% unless product_3 %}checked{% endunless %}>
              <div class="hover:border-red-200 peer-checked:border-red-600 transition-all duration-200 flex bg-white border-stone-200 border rounded-xl pt-4 pr-4 pb-4 pl-4 shadow-sm items-center justify-between">
                <div class="flex items-center gap-4">
                  <div class="w-10 h-10 rounded-full bg-stone-100 radio-indicator flex items-center justify-center text-stone-600 font-mono text-sm font-bold transition-colors">1</div>
                  <div class="">
                    <div class="font-bold text-stone-900">Pack Solitario</div>
                    <div class="text-xs text-stone-500">Para una noche de amor propio.</div>
                  </div>
                </div>
                <div class="text-right">
                  <div class="font-bold text-stone-900">
                    {% if product_1 %}{{ product_1.price | money }}{% else %}14,00€{% endif %}
                  </div>
                </div>
              </div>
            </label>

            <!-- Option 3 (Best Seller) -->
            <label class="relative cursor-pointer group">
              <input type="radio" name="pack" value="3" class="peer sr-only" onchange="updateProduct(3)" {% if product_3 %}checked{% endif %}>
              <div class="hover:border-red-200 peer-checked:border-red-600 transition-all duration-200 flex overflow-hidden bg-white border-stone-200 border-2 rounded-xl pt-4 pr-4 pb-4 pl-4 relative shadow-sm items-center justify-between">
                <div class="absolute top-0 right-0 bg-red-600 text-white text-[9px] font-bold px-2 py-0.5 rounded-bl-lg uppercase tracking-widest">Recomendado</div>
                <div class="flex items-center gap-4">
                  <div class="w-10 h-10 rounded-full bg-stone-100 radio-indicator flex items-center justify-center text-stone-600 font-mono text-sm font-bold transition-colors">3</div>
                  <div class="">
                    <div class="font-bold text-stone-900">Pack Trío</div>
                    <div class="text-xs text-stone-500">La santísima trinidad.</div>
                  </div>
                </div>
                <div class="text-right">
                  <div class="font-bold text-red-600">
                    {% if product_3 %}{{ product_3.price | money }}{% else %}28,00€{% endif %}
                  </div>
                  {% if product_3 %}
                    {% assign compare_price = product_3.compare_at_price %}
                    {% if compare_price > product_3.price %}
                      <div class="text-[10px] text-stone-400 line-through">{{ compare_price | money }}</div>
                    {% endif %}
                  {% else %}
                    <div class="text-[10px] text-stone-400 line-through">42,00€</div>
                  {% endif %}
                </div>
              </div>
            </label>

            <!-- Option 6 -->
            <label class="relative cursor-pointer group">
              <input type="radio" name="pack" value="6" class="peer sr-only" onchange="updateProduct(6)">
              <div class="hover:border-red-200 peer-checked:border-red-600 transition-all duration-200 flex bg-white border-stone-200 border rounded-xl pt-4 pr-4 pb-4 pl-4 shadow-sm items-center justify-between">
                <div class="flex items-center gap-4">
                  <div class="w-10 h-10 rounded-full bg-stone-100 radio-indicator flex items-center justify-center text-stone-600 font-mono text-sm font-bold transition-colors">6</div>
                  <div class="">
                    <div class="font-bold text-stone-900">Pack Multitud</div>
                    <div class="text-xs text-stone-500">Para borrar memoria.</div>
                  </div>
                </div>
                <div class="text-right">
                  <div class="font-bold text-stone-900">
                    {% if product_6 %}{{ product_6.price | money }}{% else %}49,00€{% endif %}
                  </div>
                  {% if product_6 %}
                    {% assign compare_price = product_6.compare_at_price %}
                    {% if compare_price > product_6.price %}
                      <div class="text-[10px] text-stone-400 line-through">{{ compare_price | money }}</div>
                    {% endif %}
                  {% else %}
                    <div class="text-[10px] text-stone-400 line-through">84,00€</div>
                  {% endif %}
                </div>
              </div>
            </label>
          </div>
        </div>

        <!-- Footer / CTA -->
        <div class="space-y-4 pt-4">
          <div class="bg-stone-50 p-4 rounded-lg border border-stone-100 flex gap-3">
            <span class="iconify text-stone-400 flex-shrink-0" data-icon="lucide:info" data-width="20"></span>
            <p class="text-sm font-medium text-stone-600 transition-opacity duration-200" id="dynamic-microcopy" style="opacity: 1;">Para cuando te quieres querer a ti mismx. Una botella, una manta y cero dramas.</p>
          </div>

          <form id="product-form" class="w-full">
            <input type="hidden" name="id" id="selected-variant-id" value="{% if product_3 %}{{ product_3.selected_or_first_available_variant.id }}{% elsif product_1 %}{{ product_1.selected_or_first_available_variant.id }}{% elsif product_6 %}{{ product_6.selected_or_first_available_variant.id }}{% endif %}">
            <button type="submit" class="shadow-stone-900/10 hover:bg-red-600 hover:shadow-red-600/20 active:scale-[0.99] transition-all duration-300 flex uppercase text-sm font-bold text-white tracking-widest bg-stone-900 w-full rounded-xl pt-4 pb-4 shadow-xl gap-x-2 gap-y-2 items-center justify-center" id="cta-button">
              <span id="cta-text">Beberme solx</span> 
              <span class="iconify" data-icon="lucide:arrow-right" data-width="16"></span>
            </button>
          </form>

          <div class="flex justify-center items-center gap-4 text-[10px] text-stone-400 uppercase tracking-wider font-medium">
            <span class="flex items-center gap-1">
                <span class="iconify text-green-500" data-icon="lucide:check" data-width="12"></span>
                Stock Limitado
            </span>
            <span class="w-px h-3 bg-stone-300"></span>
            <span>Envío Incluido</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  // Pack Selection Logic
  const packs = {
      1: {
          title: "Pack Solitario",
          microcopy: "Para cuando te quieres querer a ti mismx. Una botella, una manta y cero dramas.",
          cta: "Beberme solx",
          productId: {% if product_1 %}{{ product_1.selected_or_first_available_variant.id }}{% else %}null{% endif %}
      },
      3: {
          title: "Pack Trío",
          microcopy: "La santísima trinidad del desastre. Una para ti, dos para compartir, o tres para olvidar que es martes.",
          cta: "Compartir el pecado",
          productId: {% if product_3 %}{{ product_3.selected_or_first_available_variant.id }}{% else %}null{% endif %}
      },
      6: {
          title: "Pack Orgía",
          microcopy: "Para borrar cinta o empezar una nueva religión. Si sobra, es que sois gente aburrida.",
          cta: "Inaugurar poliamor",
          productId: {% if product_6 %}{{ product_6.selected_or_first_available_variant.id }}{% else %}null{% endif %}
      }
  };

  function updateProduct(packId) {
      const data = packs[packId];
      const microcopyEl = document.getElementById('dynamic-microcopy');
      const ctaBtn = document.getElementById('cta-button');
      const ctaText = document.getElementById('cta-text');
      const variantInput = document.getElementById('selected-variant-id');
      
      // Fade out text
      if (microcopyEl) microcopyEl.style.opacity = '0.5';

      setTimeout(() => {
          // Update Text
          if (microcopyEl) {
            microcopyEl.textContent = data.microcopy;
            microcopyEl.style.opacity = '1';
          }
          if (ctaText) ctaText.textContent = data.cta;
          if (variantInput && data.productId) variantInput.value = data.productId;

          // Update images
          const images = {
              '1': document.getElementById('pack-img-1'),
              '3': document.getElementById('pack-img-3'),
              '6': document.getElementById('pack-img-6')
          };

          Object.keys(images).forEach(key => {
              const img = images[key];
              if (!img) return;
              
              if (key === packId.toString()) {
                  img.style.opacity = '1';
              } else {
                  img.style.opacity = '0';
              }
          });
      }, 150);
  }

  // Initialize
  document.addEventListener('DOMContentLoaded', function() {
      const checkedInput = document.querySelector('input[name="pack"]:checked');
      if (checkedInput) {
          updateProduct(parseInt(checkedInput.value));
      } else if (packs[3].productId) {
          updateProduct(3);
      } else if (packs[1].productId) {
          updateProduct(1);
      }

      // Handle form submission
      const form = document.getElementById('product-form');
      if (form) {
          form.addEventListener('submit', function(e) {
              e.preventDefault();
              const variantId = document.getElementById('selected-variant-id').value;
              if (variantId) {
                  // Add to cart using Shopify AJAX API
                  fetch('/cart/add.js', {
                      method: 'POST',
                      headers: {
                          'Content-Type': 'application/json',
                      },
                      body: JSON.stringify({
                          id: variantId,
                          quantity: 1
                      })
                  })
                  .then(response => response.json())
                  .then(data => {
                      // Open cart drawer or redirect
                      window.location.href = '/cart';
                  })
                  .catch(error => {
                      console.error('Error:', error);
                      alert('Error al añadir al carrito. Por favor, inténtalo de nuevo.');
                  });
              }
          });
      }
  });
</script>
